MAKEFILE_PATH := $(abspath $(lastword $(MAKEFILE_LIST)))
SYNESTIA_BASE_DIR := $(patsubst %/,%,$(dir $(MAKEFILE_PATH)))
SYNESTIA_BUILD_DIR := $(patsubst %/,%,$(dir $(MAKEFILE_PATH)))/Build

ifeq ($(ARCH), arm)
	TOOLCHAIN_PREFIX = arm-none-eabi-
	PLATFORM = RASPI2
	CFLAGS += -O2 -mfpu=neon-vfpv4 -mfloat-abi=hard -march=armv7-a -mtune=cortex-a7
	SYNESTIA_BUILD_DIR =$(SYNESTIA_BASE_DIR)/Build/RaspberryPi3/boot
else ifeq ($(ARCH), arm64)
	TOOLCHAIN_PREFIX = aarch64-linux-gnu-
	PLATFORM = RASPI3
	CFLAGS += -O2 -mfpu=crypto-neon-fp-armv8 -mfloat-abi=hard -march=armv8-a+crc -mcpu=cortex-a53
endif

CXX = $(TOOLCHAIN_PREFIX)g++
CC = $(TOOLCHAIN_PREFIX)gcc
AS = $(TOOLCHAIN_PREFIX)as
LINK = $(TOOLCHAIN_PREFIX)ld
OBJCOPY = $(TOOLCHAIN_PREFIX)objcopy

CFLAGS += -fpic -ffreestanding -std=gnu11 -Wall -Wextra -g -nostdlib -fno-builtin -D$(PLATFORM)
ASFLAGS += -c -g
LDFLAGS +=

SUFFIXED_OBJS = $(patsubst %.o,%$(OBJ_SUFFIX).o,$(OBJS))

.SUFFIXES:

%$(OBJ_SUFFIX).o: %.c
	@echo ""
	@echo "$(notdir $(CURDIR)): CC $@"
	@echo "$(CC) $(CFLAGS) -o $@ -c $<"
	@$(CC) $(CFLAGS) -o $@ -c $<

%.ao: %.s
	@echo ""
	@echo "$(notdir $(CURDIR)): AS $@"
	@echo "$(AS) $(ASFLAGS) -o $@ $<"
	@$(AS) $(ASFLAGS) -o $@ $<

$(PROGRAM): $(SUFFIXED_OBJS) $(EXTRA_OBJS)
ifeq ($(PROGRAM), kernel)
	@echo ""
	@echo "$(notdir $(CURDIR)): LINK $(PROGRAM)"
	@echo "EXTRA_OBJS: $(EXTRA_OBJS)"
	@echo "SUFFIXED_OBJS: $(SUFFIXED_OBJS)"
	@echo "LINK: $(LDFLAGS)"
	@echo "$(LINK) $(LDFLAGS) -o $(PROGRAM) $(EXTRA_OBJS) $(SUFFIXED_OBJS)"
	@$(LINK) $(LDFLAGS) -o $(PROGRAM) $(EXTRA_OBJS) $(SUFFIXED_OBJS)
	@echo ""
	@echo "$(notdir $(CURDIR)) IMG: $(ARM7IMG)"
	@echo "$(OBJCOPY) $(PROGRAM) -O binary $(SYNESTIA_BUILD_DIR)/$(ARM7IMG)"
	@$(OBJCOPY) $(PROGRAM) -O binary $(SYNESTIA_BUILD_DIR)/$(ARM7IMG)
endif

all: $(PROGRAM)

clean:
	@echo "$(notdir $(CURDIR)): CLEAN"
	@rm -f $(PROGRAM) $(LIBRARY) $(SUFFIXED_OBJS) $(EXTRA_OBJS) $(patsubst %.o,%.d,$(SUFFIXED_OBJS) $(EXTRA_OBJS)) $(EXTRA_CLEAN)
	@find ./ -regextype posix-extended -regex ".*\.(ao)" | xargs rm -f
